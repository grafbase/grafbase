name: rust-prs

on:
  workflow_dispatch:
  pull_request:
  workflow_call:
    inputs:
      base_ref:
        type: string
        required: true

env:
  CARGO_PROFILE_DEV_DEBUG: 0
  CARGO_PROFILE_TEST_DEBUG: 0
  CARGO_TERM_COLOR: 'always'
  RUST_BACKTRACE: 1
  DEPOT_PROJECT: lc6t0h7bhh

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-rust-pr
  cancel-in-progress: true

jobs:
  what-changed:
    runs-on: depot-ubuntu-24.04-small
    outputs:
      rust-code: ${{ steps.paths-changed.outputs.rust-code }}
      grafbase-sdk: ${{ steps.paths-changed.outputs.grafbase-sdk }}
      grafbase-gateway: ${{ steps.paths-changed.outputs.grafbase-gateway }}
      integration-tests: ${{ steps.paths-changed.outputs.integration-tests }}
      grafbase-cli: ${{ steps.paths-changed.outputs.grafbase-cli }}
      gateway-docker: ${{ steps.paths-changed.outputs.gateway-docker }}
      examples: ${{ steps.paths-changed.outputs.examples }}
      engine: ${{ steps.paths-changed.outputs.engine }}
    steps:
      - uses: actions/checkout@v5

      - name: Check paths changed
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: paths-changed
        with:
          filters: |
            rust-code:
              - '**/*.rs'
              - '**/Cargo.toml'
              - '**/Cargo.lock'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'rust-toolchain.toml'
              - '.github/workflows/rust-prs.yml'
            grafbase-sdk:
              - 'crates/grafbase-sdk/**'
            grafbase-gateway:
              - 'gateway/**'
              - 'crates/gateway/**'
              - 'crates/engine/**'
              - 'crates/composition/**'
              - 'crates/parser-*/**'
            integration-tests:
              - 'crates/integration-tests/**'
              - 'gateway/**'
              - 'crates/gateway/**'
              - 'crates/engine/**'
            grafbase-cli:
              - 'grafbase/**'
              - 'crates/cli/**'
              - 'crates/grafbase-sdk/**'
            gateway-docker:
              - 'gateway/Dockerfile'
            examples:
              - 'examples/**'
            engine:
              - 'crates/engine/**'

  check-licenses:
    needs: [what-changed]
    if: needs.what-changed.outputs.rust-code == 'true'
    runs-on: depot-ubuntu-24.04-small
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/install-rust
        with:
          target: x86_64-unknown-linux-musl

      - name: Install cargo-binstall and cargo-about
        shell: bash
        run: |
          curl -LsSf https://github.com/cargo-bins/cargo-binstall/releases/latest/download/cargo-binstall-x86_64-unknown-linux-musl.tgz | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin
          cargo binstall --no-symlinks --no-confirm cargo-about

      - name: Check licenses
        shell: bash
        run: |
          cd gateway
          cargo about generate -c about.toml -o "licenses.html" about.hbs

  check-format:
    needs: [what-changed]
    if: needs.what-changed.outputs.rust-code == 'true'
    runs-on: depot-ubuntu-24.04-small
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/install-rust
        with:
          target: x86_64-unknown-linux-musl
          components: rustfmt

      - name: cargo fmt
        shell: bash
        run: |
          cargo fmt --check

      - uses: uncenter/setup-taplo@4f203fdb4f3b1e289c8382cf90d8397d2338df2e # v1.0.8
        with:
          version: '0.9.3'

      - name: taplo fmt check
        shell: bash
        run: |
          taplo fmt --check
          taplo check

  grafbase-sdk-doc:
    needs: [what-changed]
    if: needs.what-changed.outputs.grafbase-sdk == 'true'
    runs-on: depot-ubuntu-24.04-small
    steps:
      - uses: actions/checkout@v5
      - uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9
      - uses: ./.github/actions/install-rust
        with:
          target: x86_64-unknown-linux-musl
          components: rust-docs
      - uses: Swatinem/rust-cache@v2.8.0
        with:
          prefix-key: cargo-v1

      - name: cargo doc
        shell: bash
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo doc -p grafbase-sdk --no-deps

      - name: cargo doc tests
        shell: bash
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo test --doc -p grafbase-sdk

  wasm-extensions:
    needs: [what-changed]
    runs-on: depot-ubuntu-24.04-8
    if: |
      needs.what-changed.outputs.grafbase-gateway == 'true'
      || needs.what-changed.outputs.integration-tests == 'true'
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/fetch-assets
      - uses: cargo-bins/cargo-binstall@v1.15.3
      - uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9
      - uses: Swatinem/rust-cache@v2.8.0
        with:
          cache-workspace-crates: true
          prefix-key: cargo-v1
          workspaces: |
            . -> target
            crates/integration-tests/data/extensions -> target
            crates/wasi-component-loader/examples -> target

      - name: Build the grafbase cli
        shell: bash
        env:
          RUSTC_WRAPPER: sccache
        run: cargo build -p grafbase

      - name: Build the integration-tests extensions
        shell: bash
        working-directory: crates/integration-tests/data/extensions
        env:
          RUSTC_WRAPPER: sccache
        run: |
          ./build.sh

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: integration-tests-extensions
          path: crates/integration-tests/data/extensions/crates/*/build
          retention-days: 5

      - name: Build the WASI components for tests
        shell: bash
        working-directory: crates/wasi-component-loader/examples
        env:
          RUSTC_WRAPPER: sccache
        run: cargo build --target wasm32-wasip2

      - uses: actions/upload-artifact@v4
        with:
          name: example-component
          path: crates/wasi-component-loader/examples/target/wasm32-wasip2/debug/*.wasm
          retention-days: 5

  tests:
    needs: [what-changed, wasm-extensions]
    # We need the cancelled & result checks of this if to make sure that we
    # run even if some of our needs were skipped.
    # In particular we need `cancelled()` because `always()` (the other way of doing this)
    # makes this job uncancellable - which is not great.
    if: |
      needs.what-changed.outputs.rust-code == 'true'
      && !(cancelled())
      && !(contains(needs.*.result, 'failure'))
    strategy:
      fail-fast: false
      matrix:
        platform:
          [
            { 'target': 'x86_64-unknown-linux-musl', 'runner': 'depot-ubuntu-24.04-8' },
            { 'target': 'aarch64-unknown-linux-musl', 'runner': 'depot-ubuntu-24.04-arm-8' },
            { 'target': 'aarch64-apple-darwin', 'runner': 'depot-macos-latest' },
            { 'target': 'x86_64-pc-windows-msvc', 'runner': 'depot-windows-2022-8' },
          ]
    runs-on: ${{ matrix.platform.runner }}
    env:
      RUSTFLAGS: '-D warnings --cfg tracing_unstable'
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/fetch-assets
      - uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            .grafbase/wasm-cache
          key: ${{ runner.os }}-${{ matrix.platform.target }}-cargo-registry-v1-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.platform.target }}-cargo-registry-v1-

      - uses: ./.github/actions/install-rust
        with:
          target: ${{ matrix.platform.target }}
          components: clippy

      - name: Install musl
        uses: awalsh128/cache-apt-pkgs-action@latest
        if: ${{ contains(matrix.platform.target, 'linux') }}
        with:
          packages: musl musl-tools
          version: 1.0

      - name: Update musl-tools post installation
        if: ${{ contains(matrix.platform.target, 'linux') }}
        shell: bash
        run: |
          # This seems like a horrible hack that might come back to bite, but lets see!
          sudo ln -s /bin/g++ /bin/musl-g++
          sudo ln -s /bin/g++ /bin/aarch64-linux-musl-g++

      - name: Install cargo-nextest
        uses: taiki-e/install-action@d12e869b89167df346dd0ff65da342d1fb1202fb # v2.53.2
        with:
          tool: nextest

      - name: Retrieve wasi-component-loader examples
        if: needs.wasm-extensions.result != 'skipped'
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: example-component
          path: crates/wasi-component-loader/examples/target/wasm32-wasip2/debug

      - name: Retrieve integration-tests extensions
        if: needs.wasm-extensions.result != 'skipped'
        uses: actions/download-artifact@v5
        with:
          name: integration-tests-extensions
          path: crates/integration-tests/data/extensions/crates

      - name: Verify extension structure
        if: needs.wasm-extensions.result != 'skipped'
        shell: bash
        run: |
          find crates/integration-tests/data/extensions -name "*.wasm" -type f

      # TODO: Add timing reports in here somehow...

      - if: runner.os == 'Windows'
        uses: ilammy/setup-nasm@72793074d3c8cdda771dba85f6deafe00623038b # v1

      - name: Build debug binaries
        if: needs.what-changed.outputs.grafbase-cli == 'true' || needs.what-changed.outputs.grafbase-gateway == 'true'
        shell: bash
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo build --target ${{ matrix.platform.target }} --bin grafbase --bin grafbase-gateway

      - name: Clippy
        shell: bash
        run: |
          cargo clippy \
            --locked \
            --workspace \
            --target ${{ matrix.platform.target }}

      - name: Docker Login
        env:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        if: env.dockerhub_username != '' && runner.os == 'Linux'
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: depot/setup-action@b0b1ea4f69e92ebf5dea3f8713a1b0c37b2126a5 # v1

      - name: Build integration-tests docker compose
        # Will fail if there is nothing to build.
        continue-on-error: true
        if: |
          needs.what-changed.outputs.grafbase-gateway == 'true'
          && matrix.platform.target == 'x86_64-unknown-linux-musl'
        uses: depot/bake-action@2ae2529115bba41de62b77b345de48d57eca7564 # v1
        with:
          project: ${{ env.DEPOT_PROJECT }}
          token: ${{ secrets.DEPOT_TOKEN }}
          workdir: crates/integration-tests
          load: true
          pull: true

      - name: Build gateway docker compose
        # Will fail if there is nothing to build.
        continue-on-error: true
        if: |
          needs.what-changed.outputs.grafbase-gateway == 'true'
          && matrix.platform.target == 'x86_64-unknown-linux-musl'
        uses: depot/bake-action@2ae2529115bba41de62b77b345de48d57eca7564 # v1
        with:
          project: ${{ env.DEPOT_PROJECT }}
          token: ${{ secrets.DEPOT_TOKEN }}
          workdir: gateway
          load: true
          pull: true

      - name: Start integration-test docker compose
        if: |
          needs.what-changed.outputs.integration-tests == 'true'
          && matrix.platform.target == 'x86_64-unknown-linux-musl'
        shell: bash
        working-directory: crates/integration-tests
        run: |
          docker compose up -d

      - name: Start gateway docker compose
        if: |
          needs.what-changed.outputs.grafbase-gateway == 'true'
          && matrix.platform.target == 'x86_64-unknown-linux-musl'
        shell: bash
        working-directory: gateway
        run: |
          docker compose up -d

      # It's kinda useful to get build vs run timings on tests, so splitting out the build from the run
      # here
      - name: Build tests (non docker platforms)
        if: matrix.platform.target != 'x86_64-unknown-linux-musl'
        shell: bash
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo nextest run --target ${{ matrix.platform.target }} --no-run --profile ci --workspace --exclude integration-tests --exclude grafbase-gateway

      - name: Run tests (non docker platforms)
        id: tests
        if: matrix.platform.target != 'x86_64-unknown-linux-musl'
        shell: bash
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo nextest run --target ${{ matrix.platform.target }} --no-tests=warn --profile ci --workspace --exclude integration-tests --exclude grafbase-gateway

      - name: Build tests (docker platforms)
        if: matrix.platform.target == 'x86_64-unknown-linux-musl'
        shell: bash
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo nextest run --target ${{ matrix.platform.target }} --no-run --profile ci --workspace

      - name: Run tests (docker platforms)
        id: tests_docker
        if: matrix.platform.target == 'x86_64-unknown-linux-musl'
        shell: bash
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo nextest run --target ${{ matrix.platform.target }} --no-tests=warn --profile ci --workspace

      - name: Clean up cargo cache
        uses: ./.github/actions/cleanup-cargo-cache
        if: success()

  docker-gateway:
    needs: [what-changed]
    if: |
      needs.what-changed.outputs.gateway-docker == 'true'
      || needs.what-changed.outputs.examples == 'true'
      || needs.what-changed.outputs.grafbase-gateway == 'true'
    env:
      COMMIT_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
      dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
    runs-on: depot-ubuntu-24.04-8
    permissions:
      packages: write
    steps:
      - if: env.dockerhub_username != ''
        uses: actions/checkout@v5

      - name: Login to GitHub Container Registry
        if: env.dockerhub_username != ''
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: env.dockerhub_username != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        if: env.dockerhub_username != ''
        uses: depot/build-push-action@v1.16.2
        with:
          project: ${{ env.DEPOT_PROJECT }}
          token: ${{ secrets.DEPOT_TOKEN }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ghcr.io/grafbase/gateway:${{ env.COMMIT_SHA }}
          file: ./gateway/Dockerfile

  examples:
    needs: [docker-gateway]
    env:
      COMMIT_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
      dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
    strategy:
      fail-fast: false
      matrix:
        working_directory:
          - examples/authorization
          - examples/grpc-extension
          - examples/composite-rest
          - examples/grpc-composite-schemas
          - examples/dynamic-schema-contracts
    runs-on: depot-ubuntu-24.04-8
    steps:
      - name: Get sources
        uses: actions/checkout@v5

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: env.dockerhub_username != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download Hurl
        uses: gacts/install-hurl@a6765f7f715286f58a69d3be6061243578781a79 # v1

      - name: Use current image
        working-directory: ${{ matrix.working_directory }}
        run: |
          sed -i "s/\(FROM ghcr.io\/grafbase\/gateway:\)latest/\1$COMMIT_SHA/" Dockerfile.gateway

      - uses: depot/setup-action@b0b1ea4f69e92ebf5dea3f8713a1b0c37b2126a5 # v1

      - name: Build docker compose
        # Will fail if there is nothing to build.
        continue-on-error: true
        uses: depot/bake-action@2ae2529115bba41de62b77b345de48d57eca7564 # v1
        with:
          project: ${{ env.DEPOT_PROJECT }}
          token: ${{ secrets.DEPOT_TOKEN }}
          workdir: ${{ matrix.working_directory }}
          load: true
          pull: true

      - name: docker compose up
        working-directory: ${{ matrix.working_directory }}
        run: docker compose up -d

      - name: test
        working-directory: ${{ matrix.working_directory }}
        run: |
          ./healthcheck.sh
          hurl --test test.hurl

  extensions:
    name: extensions SDK (${{ matrix.version.label }})
    needs: [what-changed]
    strategy:
      fail-fast: false
      matrix:
        platform: [{ 'runner': 'depot-ubuntu-24.04-8' }]
        version:
          # From the gateway 0.46 onwards, we dropped support for the native JWT authentication.
          # So we're skipping authenticated & requires-scopes which are simple enough that we shouldn't have to worry.
          # grpc fails with a directory not found error.
          - { label: '0.12.0', ref: 'sdk-0.12.0', args: "--skip 'authenticated,requires-scopes,nats,grpc'" }
          # Not sure why NATS fails, but it's old enough that it doesn't matter.
          - { label: '0.14.0', ref: 'sdk-0.14.0', args: "--skip 'authenticated,requires-scopes,nats'" }
          # NATS test isn't reliable in 0.15
          - { label: '0.15.7', ref: 'sdk-0.15.7', args: "--skip 'authenticated,requires-scopes,nats'" }
          - { label: '0.16.1', ref: 'sdk-0.16.1', args: "--skip 'authenticated,requires-scopes'" }
          - { label: '0.17.5', ref: 'sdk-0.17.5', args: "--skip 'authenticated,requires-scopes'" }
          - { label: '0.18.2', ref: 'sdk-0.18.2', args: "--skip 'authenticated,requires-scopes'" }
          - { label: '0.20.0', ref: 'sdk-0.20.0', args: "--skip 'authenticated,requires-scopes'" }
          - { label: 'latest', ref: 'main' }
    runs-on: ${{ matrix.platform.runner }}
    if: |
      needs.what-changed.outputs.grafbase-cli == 'true'
      && needs.what-changed.outputs.grafbase-gateway == 'true'
      && !(cancelled())
      && !(contains(needs.*.result, 'failure'))
    steps:
      - uses: actions/checkout@v5
      - uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9
      - uses: ./.github/actions/install-rust
        with:
          target: x86_64-unknown-linux-musl
          components: clippy, rustfmt

      - name: Checkout Extensions
        uses: actions/checkout@v5
        with:
          repository: 'grafbase/extensions'
          ref: ${{ matrix.version.ref }}
          path: extensions

      - uses: Swatinem/rust-cache@v2.8.0
        with:
          cache-workspace-crates: true
          prefix-key: cargo-v1-${{ matrix.version.ref }}
          workspaces: |
            . -> target
            extensions -> target
          cache-directories: |
            extensions/extensions/*/build/wasm-cache

      - uses: ./.github/actions/fetch-assets

      - name: Install cargo-nextest
        uses: taiki-e/install-action@d12e869b89167df346dd0ff65da342d1fb1202fb # v2.53.2
        with:
          tool: nextest

      - name: Build CLI and Gateway
        shell: bash
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo build -p grafbase -p grafbase-gateway
          echo "$(pwd)/target/debug" >> $GITHUB_PATH

      - name: Login to Docker Hub
        env:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        if: env.dockerhub_username != '' && runner.os == 'Linux'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: depot/setup-action@b0b1ea4f69e92ebf5dea3f8713a1b0c37b2126a5 # v1

      - name: Build docker compose
        # Will fail if there is nothing to build.
        continue-on-error: true
        uses: depot/bake-action@2ae2529115bba41de62b77b345de48d57eca7564 # v1
        with:
          project: ${{ env.DEPOT_PROJECT }}
          token: ${{ secrets.DEPOT_TOKEN }}
          workdir: extensions
          load: true
          pull: true

      - name: Start extensions docker compose
        working-directory: extensions
        run: docker compose up -d

      - name: Install Protoc for the gRPC extension
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3

      - name: Build test matrix
        working-directory: extensions
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo build -p test-matrix

      - name: Test all extensions
        working-directory: extensions
        env:
          RUSTC_WRAPPER: 'sccache'
        run: |
          cargo run -p test-matrix -- -v ${{ matrix.version.args }}

  after-build-rust:
    # This job is responsible for reacting to build success or failure. It must
    # happen after the builds, hence the `needs`. But it must not be skipped
    # when the builds are cancelled or fail (hence the `if: ${{ always() }}`).
    needs: [check-format, grafbase-sdk-doc, tests, examples, extensions]
    runs-on: depot-ubuntu-24.04-small
    if: ${{ always() }}
    steps:
      - name: Check that the builds succeeded
        run: exit 1
        if: ${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}

  check-helm-template:
    name: Check Helm Template
    runs-on: ubuntu-latest
    steps:
      - name: Get sources
        uses: actions/checkout@v5

      - name: Template Charts
        working-directory: gateway/helm
        run: |
          set -e
          helm template .
