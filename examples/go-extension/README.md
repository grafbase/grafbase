# Go Extension example

This is an example extension that demonstrates how to create a Grafbase extension written in Go and compiled to WebAssembly with the component model.

The functionality is trivial: you configure a secret in your grafbase.toml, and the extension checks that the secret is passed in the Authorization header to grant or refuse access.

**Important note**: As of 2025-06-25, support for WASI preview 2 is only implemented in TinyGo, and the latest release does not include support for custom WASI worlds, limiting Go WASI-preview 2 modules to the CLI world only. Until this is addressed in a new release, this extension must be compiled with a tinygo compiler built from [this branch](https://github.com/grafbase/tinygo/tree/tomhoule-rllotvtovpww).

## Contents of this example

- `grafbase` contains the go bindings generated from the WIT definitions by `wit-bindgen-go`. See below for instructions on how to generate them yourself.
- `internal` contains stubs for guest functions not implemented by this example extension.
- `extension.go` contains the implementation of the extension.
- `grafbase.toml` is a Grafbase Gateway configuration that imports the extension, for testing purposes.
- `manifest.json` is the extension metadata. It is generated by `grafbase extension build` for regular extensions, but is authored manually for this example.
- `query.sh` is a simple bash script to run a query against the gateway. It takes the contents of the Authorization header as an argument.
- `schema.federated.graphql` is the federated schema to run with the example. The concrete schema does not matter for the example extension, since it is only in charge of authentication.
- `schemas.subgraph.graphql` is the subgraph schema the federated schema was composed from.

## Building the extension

```bash
tinygo build -x -target=wasip2 -wasi-package ../../crates/grafbase-sdk/wit/since_0_17_0/ -o target/extension.wasm  extension.go
cp manifest.json target/
```

You can also omit `-x` for less verbose output.

## Running the extension

```bash
grafbase-gateway --config grafbase.toml --schema ./schema.federated.graphql
```

## Testing that the extension works

With the gateway running (assuming the default port `5000`), use the `query.sh` script.

### Unauthenticated request

```bash
./query.sh not-a-valid-token
```

You should see a 401 Unauthorized response.

### Authenticated request

```bash
# Change the token to any other token you configured in grafbase.toml, if you changed the default.
./query.sh 1234batman
```

You will see this:

```json
{"data":{"greet":null},"errors":[{"message":"Request to subgraph 'greet' failed.","locations":[{"line":1,"column":21}],"path":["greet"],"extensions":{"code":"SUBGRAPH_REQUEST_ERROR"}}]}
```

Which means the gateway passed the request on to the subgraph (authentication was successful). There is no running subgraph in this example, so it is an error, but after the authentication step.

## Development

### Generating the bindings from WIT

Install wit-bindgen-go:

```sh
go install go.bytecodealliance.org/cmd/wit-bindgen-go@latest
```

Generate the Go bindings:

```sh
# From this directory:
wit-bindgen-go generate ../../crates/grafbase-sdk/wit/since_0_17_0
# Or from the repo root:
wit-bindgen-go generate --out examples/go-extension/ crates/grafbase-sdk/wit/since_0_17_0
```
